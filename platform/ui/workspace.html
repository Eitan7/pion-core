<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title>Dojo Reactor Workspace</title>
	<style type="text/css">
		@import "dojo/resources/dojo.css";
		@import "dojo/resources/dnd.css";
		@import "dijit/themes/tundra/tundra.css";
		@import "dojo/tests/dnd/dndDefault.css"; 

		body {
			padding: 1em;
			color:#666; 
			background-color:#dedede;
		}
		.container {
			width: 420px;
			height: 120px;
			display: block;
		}
		.clear {
			clear: both;
		}
		.moveable {
			background: #FFFFBF;
			border: 1px solid black;
			width: 50px;
			padding: 5px 10px;
			cursor: pointer;
		}
		.parent {
			background: #BFECFF;
			border: 10px solid lightblue;
			width: 500px;
			height: 150px;
			padding: 10px;
			margin: 10px;
		}
		.dojoDndItem {
			padding: 10px 20px;
			margin: 10px 20px;
			border: 4px solid black;
			cursor: pointer;
			radius:8pt;
			-moz-border-radius:8pt 8pt; 
		}
	</style>
	<script type="text/javascript" src="dojo/dojo.js" 
		djConfig="isDebug: true, parseOnLoad: true"></script>
	<script type="text/javascript" src="dojo/dnd/Mover.js"></script>
	<script type="text/javascript" src="dojo/dnd/Moveable.js"></script>
	<script type="text/javascript" src="dojo/dnd/move.js"></script>
	<script type="text/javascript" src="dojo/dnd/Container.js"></script>
	<script type="text/javascript" src="dojo/dnd/Selector.js"></script>
	<script type="text/javascript" src="dojo/dnd/Source.js"></script>
	<script type="text/javascript" src="dojo/dnd/Avatar.js"></script>
	<script type="text/javascript" src="dojo/dnd/Manager.js"></script>

	<script type="text/javascript" src="dijit/dijit.js"></script>
	<script type="text/javascript" src="dijit/Dialog.js"></script>
	<script type="text/javascript" src="dijit/form/TextBox.js"></script>
	<script type="text/javascript" src="dijit/form/Button.js"></script>
	<script type="text/javascript" src="dijit/layout/ContentPane.js"></script>
	<script type="text/javascript" src="dijit/layout/LayoutContainer.js"></script>

	<script type="text/javascript" src="dojox/gfx/shape.js"></script>
	<script type="text/javascript" src="dojox/gfx/svg.js"></script>
	<script type="text/javascript">
		dojo.require("dojo.dnd.move");
		dojo.require("dojo.parser");
		dojo.require("dojo.dnd.Source");
		dojo.require("dijit.Dialog");
		dojo.require("dijit.form.TextBox");
        dojo.require("dijit.layout.ContentPane");
        dojo.require("dijit.layout.LayoutContainer");
		dojo.require("dojox.gfx");
		//dojo.require("dojox.gfx.move");

		var surface = null;
		var first_reactor = true;
		var latest_event = null;
		var STEP = 20;

		var init = function(){
			dojo.connect(workspace_box, "onDndDrop", handleDropOnWorkspace);
			dojo.connect(workspace_box.node, "onmouseup", updateLatestMouseUpEvent);
			surface = dojox.gfx.createSurface("workspace_box_div", 500, 125);
		};
		dojo.addOnLoad(init);

		function updateLatestMouseUpEvent(e){
			latest_event = e;
			console.debug("e = ", e);
		}
		function getNearbyGridPointInBox(constraintBox, currentLeftTop) {
			//console.debug("In getNearbyGridPointInBox, constraintBox: ", constraintBox);
			var c = constraintBox;
			c.l += STEP - 1; c.l -= c.l % STEP;
			c.t += STEP - 1; c.t -= c.t % STEP;
			var newLeftTop = {};
			newLeftTop.l = currentLeftTop.l < c.l ? c.l : c.r < currentLeftTop.l ? c.r : currentLeftTop.l;
			newLeftTop.t = currentLeftTop.t < c.t ? c.t : c.b < currentLeftTop.t ? c.b : currentLeftTop.t;
			newLeftTop.l -= newLeftTop.l % STEP;
			newLeftTop.t -= newLeftTop.t % STEP;
			return newLeftTop;
		}
		function handleDropOnReactor(source, nodes, copy, target){
			console.debug('handleDropOnReactor called, target.node.getAttribute("reactor_type") = ', target.node.getAttribute("reactor_type"));
			console.debug("target.targetState = ", target.targetState);
			console.debug("target.processed = ", target.processed);
			console.debug('target.node.lastChild = ', target.node.lastChild);
			
			// handleDropOnReactor will be called more than once for a single drop.  One of these times will be just
			// after a connector node was added to the reactor.  If this is that time, delete the connector node.
			if (target.node.lastChild.getAttribute && target.node.lastChild.getAttribute("dndType") == "connector") {
				target.node.removeChild(target.node.lastChild);
			}

			// If we've already set up a connector for this target, we're done.  (When we're ready to allow
			// adding another connector, this will have to be redone.) 
			if (target.processed) return;

			//debugger;
			console.debug('nodes[0].getAttribute("dndType") = ', nodes[0].getAttribute("dndType"));
			console.debug('nodes[0].getAttribute("reactor_type") = ', nodes[0].getAttribute("reactor_type"));

			if (nodes[0].getAttribute("dndType") != "connector") {
				// This should not be reached, since reactor targets are only supposed to accept connectors.
				console.debug('nodes[0].getAttribute("dndType") != "connector"');
				return;
			}

			console.debug("I'm connecting to " + target.node.getAttribute("reactor_type"));
			//debugger;
			// This is a hack.  Note that iterating through target.node.offsetParent and accumulating the offsets does not work right.
			var xOffset = -55;
			var yOffset = -30;

			var x1 = xOffset + target.node.offsetLeft + target.node.offsetWidth;
			var y1 = yOffset + target.node.offsetTop  + target.node.offsetHeight / 2;
			console.debug("x1 = ", x1, ", y1 = ", y1);

			var children = workspace_box.node.childNodes;
			for (var i = 0; i < children.length; ++i) {
				console.debug('children[', i, '] = ', children[i]);
				if (children[i] == target.node) {
					console.debug('myself');
					continue;
				}
				if (children[i].getAttribute && children[i].getAttribute("reactor_type")) {
					var x2 = xOffset + children[i].offsetLeft;
					var y2 = yOffset + children[i].offsetTop + children[i].offsetHeight / 2;
					console.debug('x2 = ', x2, ', y2 = ', y2, ', children[', i, '].getAttribute("reactor_type") = ', children[i].getAttribute("reactor_type"));
					var shape = surface.createLine({x1: x1, y1: y1, x2: x2, y2: y2}).setStroke("black");
				}
			}

			target.processed = true;
		}

		function handleDropOnWorkspace(source, nodes, copy, target){
			console.debug("handleDropOnWorkspace called");
			if (target != workspace_box){
				// So why was handleDropOnWorkspace called?  Because the manager is using a global canDrop flag.
				// I added 
				//		if(this.targetState == "Disabled"){ break; }
				// to onDndDrop(), but that's too late to prevent handleDropOnWorkspace from getting called.
				//alert("huh?");
				return;
			}
			if (nodes[0].getAttribute("widgetid") == "connector") {
				// This should not be reached, since the workspace targets are only supposed to accept reactors.
				alert("connector must be dropped on a reactor");
				return;
			}
			//debugger;
			console.debug(copy ? "Copying from" : "Moving from", source);
			console.debug("nodes: ", nodes);
			var new_div = document.createElement("div");
			var reactor_target = new dojo.dnd.Target(new_div, {accept: ["connector"]});
			dojo.connect(reactor_target, "onDndDrop", handleDropOnReactor);
			new_div.setAttribute("class", "moveable");
			//debugger;
			var reactor_type = nodes[0].getAttribute("reactor_type");
			new_div.innerHTML = reactor_type;
			new_div.setAttribute("reactor_type", reactor_type);
			//debugger;
			workspace_box.node.replaceChild(new_div, workspace_box.node.lastChild);
			var m5 = new dojo.dnd.move.parentConstrainedMoveable(new_div, {area: "padding", within: true});
			var c = m5.constraints();
			// Since parts of the constraintBox are not calculated until onFirstMove() is called,
			// calculate them here.
			c.r = c.l + c.w - new_div.offsetWidth;
			c.b = c.t + c.h - new_div.offsetHeight;
			var newLeftTop = getNearbyGridPointInBox(c, {l: latest_event.clientX, t: latest_event.clientY});
			new_div.style.top  = newLeftTop.t + "px";
			new_div.style.left = newLeftTop.l + "px";
			new_div.style.position = "absolute";

			new_div.ondblclick = function(a){
				//console.debug("a: ", a);
				//for (key in a) { console.debug(key + ": " + a[key]); }
				var id = reactor_type + "_dialog";
				var dialog = dijit.byId(id);
				//debugger;
				//dijit.byId(id).setContent({"name": "qwerty"});
				// This makes the first field have a blue border, but doesn't put the cursor there, so it's pretty useless.
				dijit.focus(dojo.query('input', this.domNode)[0]);
				dijit.byId(id).show();
				dijit.byId(id).execute = function(dialogFields) { updateName(dialogFields, new_div); }
			}

			// Since this overrides the constrained onMove, we have to enforce the boundary constraints (in addition to the grid constraints).
			// getNearbyGridPointInBox() takes care of both.  Note that parts of this.constraintBox are not calculated until
			// onFirstMove() is called.
			m5.onMove = function(mover, leftTop){
				var newLeftTop = getNearbyGridPointInBox(this.constraintBox, leftTop);
				dojo.marginBox(mover.node, newLeftTop);
			};
/*
			// This doesn't do anything, because the constrained onMove doesn't call onMoving.
			dojo.connect(m5, "onMoving", function(mover, leftTop){
				console.debug("m5 is moving");
				leftTop.l -= leftTop.l % STEP;
				leftTop.t -= leftTop.t % STEP;
			});
/**/
		}
		function updateName(dialogFields, node) {
			node.innerHTML = dialogFields.name;
		}
	</script>
</head>
<body class="tundra">
	<div dojoType="dojo.dnd.Target" id="workspace_box_div" jsId="workspace_box" class="container" accept="reactor" horizontal="true">
	</div>
	<div style="width: 600px">
		<div style="float: left; margin: 5px;">
			<h3>Reactor Types</h3>
			<table id="container4" border="1px solid black">
				<tr>
					<td>Collection</td>
					<td>Processing</td>
					<td>Storage</td>
				</tr>
				<tr>
					<td dojoType="dojo.dnd.Source" copyOnly="true">
						<div class="dojoDndItem" dndType="reactor" reactor_type="log_files">log files</div>
					</td>
					<td dojoType="dojo.dnd.Source" copyOnly="true">
						<div class="dojoDndItem" dndType="reactor" reactor_type="filter">filter</div>
						<div class="dojoDndItem" dndType="reactor" reactor_type="transform">transform</div>
					</td>
					<td dojoType="dojo.dnd.Source" copyOnly="true">
						<div class="dojoDndItem" dndType="reactor" reactor_type="data_store">data store</div>
					</td>
				</tr>
			</table>
		</div>
		<div style="float: right; margin: 5px; border="10px solid black">
			<h3>Connect Reactors</h3>
			<div dojoType="dojo.dnd.Source" copyOnly="true">
				<div>drag to connect</div>
				<div class="dojoDndItem" dndType="connector" reactor_type="connector">----------></div>
				<!--
				// Button isn't working here - somehow the dndType isn't being used.
				<button dojoType=dijit.form.Button class="dojoDndItem" dndType="connector" reactor_type="connector" id="connector">-------------></button>
				-->
			</div>
		</div>
	</div>
	<!--
				<td align="center"><button dojoType=dijit.form.Button type="put_something_here_1" onclick=alert("hook this up to Delete")>Delete</button></td>
				<td align="center"><button dojoType=dijit.form.Button type="put_something_here_2" onclick=alert("hook this up to Cancel (same as clicking 'x' in corner)")>Cancel</button></td>
	-->
	<div dojoType="dijit.Dialog" id="log_files_dialog" title="Log Configuration">
		<table>
			<tr>
				<td><label for="name">Name: </label></td>
				<td><input dojoType="dijit.form.TextBox" type="do_I_need_this_1" name="name"></td>
			</tr>
			<tr>
				<td><label for="is _this_used">Comments: </label></td>
				<td><input dojoType="dijit.form.TextBox" type="do_I_need_this_2" name="comments"></td>
			</tr>
			<tr>
				<td><label for="how_about_this">Event Type: </label></td>
				<td><input dojoType="dijit.form.TextBox" type="do_I_need_this_3" name="event_type"></td>
			</tr>
			<tr>
				<td align="center"><button dojoType=dijit.form.Button type="put_something_here_1" onclick=alert("Delete")>Delete</button></td>
				<td align="center"><button dojoType=dijit.form.Button type="put_something_here_2" onclick=alert("Cancel")>Cancel</button></td>
				<td align="center"><button dojoType=dijit.form.Button type="submit">Save</button></td>
			</tr>
		</table>
	</div>
	<div dojoType="dijit.Dialog" id="filter_dialog" title="Filter Configuration">
		<table>
			<tr>
			<tr>
				<td><label for="name">Name: </label></td>
				<td><input dojoType="dijit.form.TextBox" type="do_I_need_this_1" name="name"></td>
			</tr>
			<tr>
				<td><label for="loc">Comments: </label></td>
				<td><input dojoType="dijit.form.TextBox" type="do_I_need_this_2" name="comments"></td>
			</tr>
			<tr>
				<td align="center"><button dojoType=dijit.form.Button type="put_something_here_1" onclick=alert("Delete")>Delete</button></td>
				<td align="center"><button dojoType=dijit.form.Button type="put_something_here_2" onclick=alert("Cancel")>Cancel</button></td>
				<td align="center"><button dojoType=dijit.form.Button type="submit">Save</button></td>
			</tr>
		</table>
	</div>
	<div dojoType="dijit.Dialog" id="transform_dialog" title="Transform Configuration">
		<table>
			<tr>
			<tr>
				<td><label for="name">Name: </label></td>
				<td><input dojoType="dijit.form.TextBox" type="do_I_need_this_1" name="name"></td>
			</tr>
			<tr>
				<td><label for="loc">Comments: </label></td>
				<td><input dojoType="dijit.form.TextBox" type="do_I_need_this_2" name="comments"></td>
			</tr>
			<tr>
				<td align="center"><button dojoType=dijit.form.Button type="put_something_here_1" onclick=alert("Delete")>Delete</button></td>
				<td align="center"><button dojoType=dijit.form.Button type="put_something_here_2" onclick=alert("Cancel")>Cancel</button></td>
				<td align="center"><button dojoType=dijit.form.Button type="submit">Save</button></td>
			</tr>
		</table>
	</div>
	<div dojoType="dijit.Dialog" id="data_store_dialog" title="Storage Configuration">
		<table>
			<tr>
			<tr>
				<td><label for="name">Name: </label></td>
				<td><input dojoType="dijit.form.TextBox" type="do_I_need_this_1" name="name"></td>
			</tr>
			<tr>
				<td><label for="loc">Comments: </label></td>
				<td><input dojoType="dijit.form.TextBox" type="do_I_need_this_2" name="comments"></td>
			</tr>
			<tr>
				<td align="center"><button dojoType=dijit.form.Button type="put_something_here_1" onclick=alert("Delete")>Delete</button></td>
				<td align="center"><button dojoType=dijit.form.Button type="put_something_here_2" onclick=alert("Cancel")>Cancel</button></td>
				<td align="center"><button dojoType=dijit.form.Button type="submit">Save</button></td>
			</tr>
		</table>
	</div>
</body>
</html>
